<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Folder Collections – Konfiguration</title>
  <style>
    .inputContainer { margin: 12px 0; }
    .checkboxLabel { display: flex; gap: 8px; align-items: center; }
    .fieldDescription { color: #888; font-size: 0.9em; margin-left: 26px; }
    .actions { margin-top: 16px; display: flex; gap: 8px; }
  </style>
</head>
<body>
  <div id="folderCollectionsConfigPage">
    <form id="fcForm">
      <div class="inputContainer">
        <label class="checkboxLabel">
          <input id="includeMovies" type="checkbox" />
          Filme berücksichtigen
        </label>
      </div>

      <div class="inputContainer">
        <label class="checkboxLabel">
          <input id="includeSeries" type="checkbox" />
          Serien berücksichtigen
        </label>
      </div>

      <div class="inputContainer">
        <label for="minItems">Mindestanzahl Items</label><br/>
        <input id="minItems" type="number" min="0" step="1" />
        <div class="fieldDescription">Nur wenn mindestens so viele Items gefunden werden, wird eine Sammlung erstellt/aktualisiert.</div>
      </div>

      <div class="inputContainer">
        <label for="prefix">Prefix</label><br/>
        <input id="prefix" type="text" />
      </div>

      <div class="inputContainer">
        <label for="suffix">Suffix</label><br/>
        <input id="suffix" type="text" />
      </div>

      <div class="inputContainer">
        <label>Scan-Uhrzeit</label><br/>
        <input id="scanHour" type="number" min="0" max="23" style="width:80px" /> :
        <input id="scanMinute" type="number" min="0" max="59" style="width:80px" />
      </div>

      <div class="inputContainer">
        <label for="pathPrefixes">Wurzelpfade (je Zeile)</label><br/>
        <textarea id="pathPrefixes" rows="5" style="width:100%"></textarea>
      </div>

      <div class="inputContainer">
        <label for="ignorePatterns">Ignore-Muster (je Zeile)</label><br/>
        <textarea id="ignorePatterns" rows="4" style="width:100%"></textarea>
        <div class="fieldDescription">Wildcards (*, ?) – oder Regex mit Präfix <code>re:</code></div>
      </div>

      <!-- NEU: Basename-Checkbox -->
      <div class="inputContainer">
        <label class="checkboxLabel">
          <input id="useBasename" type="checkbox" />
          Basename als Sammlungsname verwenden
        </label>
        <div class="fieldDescription">
          Wenn aktiv: letzter Ordnername als Sammlungsname; sonst kompletter Pfad.
        </div>
      </div>

      <div class="actions">
        <button id="fcManualScan" class="raised button-submit" type="button">Manuellen Scan starten</button>
        <button class="raised button-submit" type="submit">Speichern</button>
        <button id="fcCancel" class="raised button-cancel" type="button">Abbrechen</button>
      </div>
    </form>
  </div>

  <script>
  (() => {
    const pluginId = "9f4f2c47-b3c5-4b13-9b1f-1c9a5c3b8d6a";
    const $ = (id) => document.getElementById(id);
    const toLines   = (arr)  => Array.isArray(arr) ? arr.join("\\n") : (arr || "");
    const fromLines = (text) => (text || "").split("\\n").map(s => s.trim()).filter(Boolean);

    function buildErrorMessage(err) {
      try {
        if (err == null) return "Unbekannter Fehler";
        if (typeof err === "string") return err;
        const status     = typeof err.status !== "undefined" ? err.status : null;
        const statusText = typeof err.statusText === "string" ? err.statusText : "";
        const message    = typeof err.message === "string" ? err.message : "";
        if (status || statusText) {
          const head = status ? \`HTTP \${status}\${statusText ? " " : ""}\${statusText}\` : statusText;
          return message ? \`\${head} – \${message}\` : head;
        }
        if (message) return message;
        return JSON.stringify(err);
      } catch { return "Unbekannter Fehler"; }
    }

    async function safeReadBody(resp) {
      try {
        if (!resp || typeof resp.text !== "function") return "";
        const t = await resp.text();
        return (t || "").slice(0, 200);
      } catch { return ""; }
    }

    async function load() {
      try {
        const cfg = await ApiClient.getPluginConfiguration(pluginId);

        $("includeMovies").checked = !!cfg.IncludeMovies;
        $("includeSeries").checked = !!cfg.IncludeSeries;
        $("minItems").value  = cfg.MinItems  ?? 2;
        $("prefix").value    = cfg.Prefix    ?? "";
        $("suffix").value    = cfg.Suffix    ?? "";
        $("scanHour").value  = cfg.ScanHour  ?? 4;
        $("scanMinute").value= cfg.ScanMinute?? 0;
        $("pathPrefixes").value  = toLines(cfg.PathPrefixes);
        $("ignorePatterns").value= toLines(cfg.IgnorePatterns);
        $("useBasename").checked = !!cfg.UseBasenameAsCollectionName;
      } catch (err) {
        Dashboard.alert("Konfiguration konnte nicht geladen werden: " + buildErrorMessage(err));
        console.error(err);
      }
    }

    async function save() {
      try {
        const cfg = await ApiClient.getPluginConfiguration(pluginId);

        cfg.IncludeMovies = $("includeMovies").checked;
        cfg.IncludeSeries = $("includeSeries").checked;
        cfg.MinItems = parseInt($("minItems").value, 10) || 0;
        cfg.Prefix   = $("prefix").value.trim();
        cfg.Suffix   = $("suffix").value.trim();

        const hour   = Math.min(23, Math.max(0, parseInt($("scanHour").value, 10)   || 4));
        const minute = Math.min(59, Math.max(0, parseInt($("scanMinute").value, 10) || 0));
        cfg.ScanHour   = hour;
        cfg.ScanMinute = minute;

        cfg.PathPrefixes   = fromLines($("pathPrefixes").value);
        cfg.IgnorePatterns = fromLines($("ignorePatterns").value);

        cfg.UseBasenameAsCollectionName = !!$("useBasename").checked;

        const result = await ApiClient.updatePluginConfiguration(pluginId, cfg);
        Dashboard.processPluginConfigurationUpdateResult(result);

        // Direkt prüfen, was der Server jetzt zurückliefert
        const verify = await ApiClient.getPluginConfiguration(pluginId);
        const want = !!$("useBasename").checked;
        const got  = !!verify.UseBasenameAsCollectionName;

        if (result?.IsUpdated === false) {
          Dashboard.alert("Konfiguration konnte nicht gespeichert werden.");
        } else if (want !== got) {
          Dashboard.alert("Hinweis: 'Basename als Sammlungsname' wurde serverseitig nicht übernommen. Prüfe PluginConfiguration.");
          console.warn("Roundtrip mismatch: wanted", want, "got", got, verify);
        } else {
          Dashboard.alert("Gespeichert.");
        }
      } catch (err) {
        Dashboard.alert("Speichern fehlgeschlagen: " + buildErrorMessage(err));
        console.error(err);
      }
    }

    async function manualScan(btn) {
      try {
        btn?.setAttribute("disabled", "disabled");
        btn?.classList.add("idleProcessing");

        const tasks = await ApiClient.getJSON(ApiClient.getUrl("ScheduledTasks"));
        const t = tasks.find(x =>
          x?.Key === "FolderCollections.DailyScan" ||
          (typeof x?.Name === "string" && x.Name.toLowerCase().includes("folder collections"))
        );
        if (!t?.Id) throw new Error("FolderCollections-Task nicht gefunden.");

        let resp = await ApiClient.fetchApi(\`/ScheduledTasks/\${t.Id}/Trigger\`, { method: "POST" });
        if (!resp?.ok) {
          resp = await ApiClient.fetchApi(\`/ScheduledTasks/Running/\${t.Id}\`, { method: "POST" });
          if (!resp?.ok) {
            const txt = await safeReadBody(resp);
            throw new Error(\`\${resp?.status || ""} \${resp?.statusText || ""} \${txt}\`.trim());
          }
        }

        Dashboard.alert("Manueller Scan gestartet!");
      } catch (err) {
        Dashboard.alert("Fehler beim Starten des Scans: " + buildErrorMessage(err));
        console.error(err);
      } finally {
        btn?.removeAttribute("disabled");
        btn?.classList.remove("idleProcessing");
      }
    }

    function init() {
      const page = $("folderCollectionsConfigPage");
      if (!page || page.dataset.initialized === "1") return;
      page.dataset.initialized = "1";

      $("fcForm")?.addEventListener("submit", (ev) => {
        ev.preventDefault();
        save().catch((err) => {
          Dashboard.alert("Speichern fehlgeschlagen: " + buildErrorMessage(err));
          console.error(err);
        });
      });

      $("fcCancel")?.addEventListener("click", (ev) => {
        ev.preventDefault();
        history.back();
      });

      $("fcManualScan")?.addEventListener("click", (ev) => {
        ev.preventDefault();
        manualScan(ev.currentTarget).catch((err) => {
          Dashboard.alert("Fehler beim Starten des Scans: " + buildErrorMessage(err));
          console.error(err);
        });
      });

      load().catch((err) => {
        Dashboard.alert("Konfiguration konnte nicht geladen werden: " + buildErrorMessage(err));
        console.error(err);
      });
    }

    document.addEventListener("DOMContentLoaded", init);
    document.addEventListener("viewshow", init);
    document.addEventListener("pageshow", init);
  })();
  </script>
</body>
</html>
