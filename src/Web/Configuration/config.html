<div id="folderCollectionsConfigPage"
     data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-require="emby-button,emby-input,emby-select,emby-checkbox">

  <div class="content-primary">
    <div class="verticalSection">
      <h1>Folder Collections – Einstellungen</h1>

      <form id="fcForm" class="form">
        <div class="inputContainer">
          <label class="checkboxLabel">
            <input is="emby-checkbox" id="includeMovies" type="checkbox" />
            <span>Filme einbeziehen</span>
          </label>
        </div>

        <div class="inputContainer">
          <label class="checkboxLabel">
            <input is="emby-checkbox" id="includeSeries" type="checkbox" />
            <span>Serien einbeziehen</span>
          </label>
        </div>

        <div class="inputContainer">
          <label for="minItems">Min. Items/Ordner</label>
          <input is="emby-input" id="minItems" type="number" min="0" step="1" required>
        </div>

        <div class="inputContainer">
          <label for="prefix">Prefix</label>
          <input is="emby-input" id="prefix" type="text" placeholder="z.B. Box:">
        </div>

        <div class="inputContainer">
          <label for="suffix">Suffix</label>
          <input is="emby-input" id="suffix" type="text" placeholder="z.B. Collection">
        </div>

        <div class="inputContainer flex align-items-center">
          <label for="scanHour">Tägliche Scan-Zeit</label>
          <div class="flex" style="gap:.5rem; align-items:center;">
            <input is="emby-input" id="scanHour" type="number" min="0" max="23" step="1" style="width:5rem;">
            :
            <input is="emby-input" id="scanMinute" type="number" min="0" max="59" step="1" style="width:5rem;">
          </div>
        </div>

        <div class="inputContainer">
          <label for="pathPrefixes">Pfad-Präfixe (Whitelist, eine pro Zeile)</label>
          <textarea is="emby-input" id="pathPrefixes" rows="4"></textarea>
        </div>

        <div class="inputContainer">
          <label for="ignorePatterns">Ignore-Patterns (Regex, eine pro Zeile)</label>
          <textarea is="emby-input" id="ignorePatterns" rows="4"></textarea>
        </div>

        <div class="buttons formButtons">
          <button is="emby-button" type="button" class="raised button-cancel" id="fcCancel">Abbrechen</button>
          <button is="emby-button" type="submit" class="raised accent button-submit" id="fcSave">Speichern</button>
          <button is="emby-button" type="button" class="raised" id="fcManualScan">Manuell scannen</button>
        </div>
      </form>
    </div>
  </div>

  <script>
  (() => {
    // EXAKT deine GUID:
    const pluginId = "9f4f2c47-b3c5-4b13-9b1f-1c9a5c3b8d6a";

    const toLines = arr => Array.isArray(arr) ? arr.join("\n") : (arr || "");
    const fromLines = txt => (txt || "").split("\n").map(s => s.trim()).filter(Boolean);

    async function load() {
      const cfg = await ApiClient.getPluginConfiguration(pluginId);
      document.getElementById("includeMovies").checked = !!cfg.IncludeMovies;
      document.getElementById("includeSeries").checked = !!cfg.IncludeSeries;
      document.getElementById("minItems").value = cfg.MinItems ?? 2;
      document.getElementById("prefix").value = cfg.Prefix ?? "";
      document.getElementById("suffix").value = cfg.Suffix ?? "";
      document.getElementById("scanHour").value = cfg.ScanHour ?? 4;
      document.getElementById("scanMinute").value = cfg.ScanMinute ?? 0;
      document.getElementById("pathPrefixes").value = toLines(cfg.PathPrefixes);
      document.getElementById("ignorePatterns").value = toLines(cfg.IgnorePatterns);
    }

    async function save() {
      const cfg = await ApiClient.getPluginConfiguration(pluginId);

      cfg.IncludeMovies = document.getElementById("includeMovies").checked;
      cfg.IncludeSeries = document.getElementById("includeSeries").checked;
      cfg.MinItems = parseInt(document.getElementById("minItems").value, 10) || 0;
      cfg.Prefix = document.getElementById("prefix").value.trim();
      cfg.Suffix = document.getElementById("suffix").value.trim();

      const hour = Math.min(23, Math.max(0, parseInt(document.getElementById("scanHour").value, 10) || 4));
      const minute = Math.min(59, Math.max(0, parseInt(document.getElementById("scanMinute").value, 10) || 0));
      cfg.ScanHour = hour;
      cfg.ScanMinute = minute;

      cfg.PathPrefixes = fromLines(document.getElementById("pathPrefixes").value);
      cfg.IgnorePatterns = fromLines(document.getElementById("ignorePatterns").value);

      const result = await ApiClient.updatePluginConfiguration(pluginId, cfg);
      Dashboard.processPluginConfigurationUpdateResult(result);
      Dashboard.alert(result?.IsUpdated === false ? "Konfiguration konnte nicht gespeichert werden." : "Gespeichert.");
    }

    // Task manuell starten (offizielle Methode + Fallbacks)
    async function manualScan(btn) {
      const tidyError = (err) => {
        if (!err) return "Unbekannter Fehler";
        if (typeof err === "string") return err;
        if (err.status) return `${err.status} ${err.statusText || ""}`.trim();
        if (err.message) return err.message;
        try { return JSON.stringify(err); } catch { return String(err); }
      };

      let taskId = null;

      try {
        btn?.setAttribute("disabled","disabled");
        btn?.classList.add("idleProcessing");

        // 1) Task-Liste holen
        const tasks = await ApiClient.getJSON(ApiClient.getUrl("ScheduledTasks"));
        const t = tasks.find(x =>
          x?.Key === "FolderCollections.DailyScan" ||
          (typeof x?.Name === "string" && x.Name.toLowerCase().includes("folder collections"))
        );
        if (!t?.Id) throw new Error("FolderCollections-Task nicht gefunden.");
        taskId = t.Id;

        // 2) Offiziell starten
        await ApiClient.startScheduledTask(taskId);

        Dashboard.alert("Manueller Scan gestartet!");
      } catch (e1) {
        try {
          // Fallback-Route 1
          if (taskId == null) throw e1;
          const triggerUrl = ApiClient.getUrl(`ScheduledTasks/${taskId}/Trigger`);
          await ApiClient.ajax({ type: "POST", url: triggerUrl });
          Dashboard.alert("Manueller Scan gestartet (Fallback).");
        } catch (e2) {
          try {
            // Fallback-Route 2 (sehr alt)
            if (taskId == null) throw e2;
            const legacyUrl = ApiClient.getUrl(`ScheduledTasks/Running/${taskId}`);
            await ApiClient.ajax({ type: "POST", url: legacyUrl });
            Dashboard.alert("Manueller Scan gestartet (Legacy).");
          } catch (e3) {
            Dashboard.alert("Fehler beim Starten des Scans: " + tidyError(e3));
            console.error(e3);
          }
        }
      } finally {
        btn?.removeAttribute("disabled");
        btn?.classList.remove("idleProcessing");
      }
    }

    function init() {
      const page = document.getElementById("folderCollectionsConfigPage");
      if (!page || page.dataset.initialized === "1") return;
      page.dataset.initialized = "1";

      const form = document.getElementById("fcForm");
      const cancelBtn = document.getElementById("fcCancel");
      const scanBtn = document.getElementById("fcManualScan");

      form?.addEventListener("submit", (e) => { e.preventDefault(); save().catch(console.error); });
      cancelBtn?.addEventListener("click", (e) => { e.preventDefault(); history.back(); });
      scanBtn?.addEventListener("click", (e) => { e.preventDefault(); manualScan(e.currentTarget).catch(console.error); });

      load().catch(console.error);
    }

    document.addEventListener("DOMContentLoaded", init);
    document.addEventListener("viewshow", init);
    document.addEventListener("pageshow", init);
  })();
  </script>
</div>
