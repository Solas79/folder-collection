<div id="folderCollectionsConfigPage"
     data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-require="emby-button,emby-checkbox,emby-input">

  <div class="content-primary">
    <h1>Folder Collections – Einstellungen</h1>

    <!-- SAVE läuft komplett im onsubmit-Attribut -->
    <form id="fcForm" class="emby-form"
          onsubmit="(async function(ev){
            ev && ev.preventDefault && ev.preventDefault();
            const pid='9f4f2c47-b3c5-4b13-9b1f-1c9a5c3b8d6a';
            try{
              const $=id=>document.getElementById(id);
              const fromLines=t=>(t||'').split('\n').map(s=>s.trim()).filter(Boolean);
              const cfg=await ApiClient.getPluginConfiguration(pid);

              cfg.IncludeMovies = $('includeMovies').checked;
              cfg.IncludeSeries = $('includeSeries').checked;
              cfg.MinItems = parseInt($('minItems').value,10) || 0;
              cfg.Prefix = $('prefix').value.trim();
              cfg.Suffix = $('suffix').value.trim();

              const h=Math.min(23,Math.max(0,parseInt($('scanHour').value,10)||4));
              const m=Math.min(59,Math.max(0,parseInt($('scanMinute').value,10)||0));
              cfg.ScanHour=h; cfg.ScanMinute=m;

              cfg.PathPrefixes   = fromLines($('pathPrefixes').value);
              cfg.IgnorePatterns = fromLines($('ignorePatterns').value);

              cfg.UseBasenameAsCollectionName = !!$('useBasename').checked;

              const result = await ApiClient.updatePluginConfiguration(pid,cfg);
              Dashboard.processPluginConfigurationUpdateResult(result);

              // Roundtrip-Check
              const verify = await ApiClient.getPluginConfiguration(pid);
              const want = !!$('useBasename').checked;
              const got  = !!verify.UseBasenameAsCollectionName;

              if(result && result.IsUpdated===false){
                Dashboard.alert('Konfiguration konnte nicht gespeichert werden.');
              }else if(want!==got){
                Dashboard.alert('Hinweis: \"Basename als Sammlungsname\" wurde serverseitig nicht übernommen. Prüfe PluginConfiguration.cs');
                console.warn('Roundtrip mismatch', {want,got,verify});
              }else{
                Dashboard.alert('Gespeichert.');
              }
            }catch(err){
              const s = (err && (err.message||err.statusText||('HTTP '+(err.status||'')))) || 'Unbekannter Fehler';
              Dashboard.alert('Speichern fehlgeschlagen: '+s);
              console.error(err);
            }
            return false;
          })(event); return false;">

      <div class="checkboxContainer">
        <label class="emby-checkbox-label">
          <input id="includeMovies" type="checkbox" is="emby-checkbox" />
          <span>Filme berücksichtigen</span>
        </label>
      </div>

      <div class="checkboxContainer">
        <label class="emby-checkbox-label">
          <input id="includeSeries" type="checkbox" is="emby-checkbox" />
          <span>Serien berücksichtigen</span>
        </label>
      </div>

      <div class="inputContainer">
        <label class="emby-input-label" for="minItems">Mindestanzahl Items</label>
        <input id="minItems" is="emby-input" type="number" min="0" step="1" />
        <div class="fieldDescription">Nur wenn mindestens so viele Items gefunden werden, wird eine Sammlung erstellt/aktualisiert.</div>
      </div>

      <div class="inputContainer">
        <label class="emby-input-label" for="prefix">Prefix</label>
        <input id="prefix" is="emby-input" type="text" />
      </div>

      <div class="inputContainer">
        <label class="emby-input-label" for="suffix">Suffix</label>
        <input id="suffix" is="emby-input" type="text" />
      </div>

      <div class="inputContainer">
        <label class="emby-input-label">Scan-Uhrzeit</label>
        <div style="display:flex; gap:.5rem; align-items:center">
          <input id="scanHour" is="emby-input" type="number" min="0" max="23" style="width:90px" />
          :
          <input id="scanMinute" is="emby-input" type="number" min="0" max="59" style="width:90px" />
        </div>
      </div>

      <div class="inputContainer">
        <label class="emby-input-label" for="pathPrefixes">Wurzelpfade (je Zeile)</label>
        <textarea id="pathPrefixes" rows="5" is="emby-input" style="width:100%"></textarea>
      </div>

      <div class="inputContainer">
        <label class="emby-input-label" for="ignorePatterns">Ignore-Muster (je Zeile)</label>
        <textarea id="ignorePatterns" rows="4" is="emby-input" style="width:100%"></textarea>
        <div class="fieldDescription">Wildcards (*, ?) – oder Regex mit Präfix <code>re:</code></div>
      </div>

      <div class="checkboxContainer">
        <label class="emby-checkbox-label">
          <input id="useBasename" type="checkbox" is="emby-checkbox" />
          <span>Basename als Sammlungsname verwenden</span>
        </label>
        <div class="fieldDescription">Wenn aktiv: letzter Ordnername; sonst kompletter Pfad.</div>
      </div>

      <div class="formButtons">
        <!-- MANUAL SCAN komplett im onclick-Attribut -->
        <button id="fcManualScan" is="emby-button" type="button" class="raised button-submit"
          onclick="(async function(btn){
            btn && btn.setAttribute && btn.setAttribute('disabled','disabled');
            btn && btn.classList && btn.classList.add('idleProcessing');
            const pid='9f4f2c47-b3c5-4b13-9b1f-1c9a5c3b8d6a';
            try{
              const tasks = await ApiClient.getJSON(ApiClient.getUrl('ScheduledTasks'));
              const t = tasks && tasks.find && tasks.find(x => (x && (x.Key==='FolderCollections.DailyScan' || (x.Name||'').toLowerCase().includes('folder collections'))));
              if(!t || !t.Id) throw new Error('FolderCollections-Task nicht gefunden.');

              let resp = await ApiClient.fetchApi(`/ScheduledTasks/${t.Id}/Trigger`, { method:'POST' });
              if(!resp || !resp.ok){
                resp = await ApiClient.fetchApi(`/ScheduledTasks/Running/${t.Id}`, { method:'POST' });
                if(!resp || !resp.ok){
                  let txt=''; try{ txt = await resp.text(); }catch(_){}
                  throw new Error(`${(resp&&resp.status)||''} ${(resp&&resp.statusText)||''} ${txt}`.trim());
                }
              }
              Dashboard.alert('Manueller Scan gestartet!');
            }catch(err){
              const s = (err && (err.message||err.statusText||('HTTP '+(err.status||'')))) || 'Unbekannter Fehler';
              Dashboard.alert('Fehler beim Starten des Scans: '+s);
              console.error(err);
            }finally{
              btn && btn.removeAttribute && btn.removeAttribute('disabled');
              btn && btn.classList && btn.classList.remove('idleProcessing');
            }
          })(this)">
          Manuellen Scan starten
        </button>

        <button is="emby-button" type="submit" class="raised button-submit">Speichern</button>

        <!-- Abbrechen funktioniert weiterhin -->
        <button id="fcCancel" is="emby-button" type="button" class="raised button-cancel"
                onclick="history.back()">Abbrechen</button>
      </div>
    </form>
  </div>
</div>

<!-- LOAD beim Aufruf: direkt in onload-Attribut der Seite -->
<div style="display:none" onload="(async function(){
  try{
    const pid='9f4f2c47-b3c5-4b13-9b1f-1c9a5c3b8d6a';
    const $=id=>document.getElementById(id);
    const toLines=arr=>Array.isArray(arr)?arr.join('\n'):(arr||'');
    const cfg=await ApiClient.getPluginConfiguration(pid);

    $('includeMovies').checked = !!cfg.IncludeMovies;
    $('includeSeries').checked = !!cfg.IncludeSeries;
    $('minItems').value  = (cfg.MinItems ?? 2);
    $('prefix').value    = (cfg.Prefix ?? '');
    $('suffix').value    = (cfg.Suffix ?? '');
    $('scanHour').value  = (cfg.ScanHour ?? 4);
    $('scanMinute').value= (cfg.ScanMinute ?? 0);
    $('pathPrefixes').value   = toLines(cfg.PathPrefixes);
    $('ignorePatterns').value = toLines(cfg.IgnorePatterns);
    $('useBasename').checked  = !!cfg.UseBasenameAsCollectionName;
  }catch(err){
    const s=(err && (err.message||err.statusText||('HTTP '+(err.status||'')))) || 'Unbekannter Fehler';
    Dashboard.alert('Konfiguration konnte nicht geladen werden: '+s);
    console.error(err);
  }
})()"></div>
