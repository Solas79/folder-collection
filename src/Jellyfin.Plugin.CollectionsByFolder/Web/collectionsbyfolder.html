<!-- Web/collectionsbyfolder.html -->
<div data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-title="Collections by Folder"
     data-pluginid="f58f3a40-6a8a-48e8-9b3a-9d7f0b6a3a41"
     id="cbfPage">

  <style>
    /* Überschrift tiefer, kollidiert nicht mit Zurück-Pfeil */
    #cbfPage h1 { margin-top: 1.25rem; }

    /* Statusfeld optisch wie Button/Chip */
    #cbf-status {
      display: none;
      margin: .75rem 0 1rem 0;
      padding: .65rem .9rem;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      background: rgba(255,255,255,.06);
      font-weight: 600;
    }
    #cbf-status.ok    { color: #0a7a0a; }
    #cbf-status.error { color: #b00020; }
  </style>

  <div data-role="content" class="content-primary">
    <h1>Collections by Folder</h1>

    <!-- Statusanzeige -->
    <div id="cbf-status" aria-live="polite"></div>

    <form id="cbfForm"
          method="post"
          action="#"
          enctype="application/x-www-form-urlencoded"
          data-ajax="false">

      <div class="inputContainer">
        <label for="whitelist">Whitelist (ein Pfad pro Zeile)</label>
        <textarea id="whitelist" name="whitelist" rows="6" spellcheck="false"></textarea>
      </div>

      <div class="inputContainer">
        <label for="blacklist">Blacklist (ein Pfad pro Zeile)</label>
        <textarea id="blacklist" name="blacklist" rows="6" spellcheck="false"></textarea>
      </div>

      <div class="inputContainer">
        <label for="prefix">Präfix</label>
        <input id="prefix" name="prefix" type="text" />
      </div>

      <div class="inputContainer">
        <label for="suffix">Suffix</label>
        <input id="suffix" name="suffix" type="text" />
      </div>

      <div class="inputContainer">
        <label for="minfiles">Mindestanzahl Dateien</label>
        <input id="minfiles" name="minfiles" type="number" min="0" value="0" />
      </div>

      <div style="gap:.75rem; margin-top:1rem; display:flex; flex-wrap:wrap;">
        <!-- Plain submit: robust -->
        <input type="submit" value="Speichern" class="raised button block" data-role="none" id="saveButton" />
        <button type="button" class="raised button block" data-role="none" id="scanButton">Jetzt scannen</button>
      </div>
    </form>

    <p class="fieldDescription" style="margin-top:1rem;">
      Die aktuellen Werte werden automatisch geladen. Beim Speichern bleibt die Seite offen.
    </p>
  </div>

  <!-- Inline-Script: ES5, BasePath-sicher, fetch/XHR-Fallback, Status 3s -->
  <script>
  (function () {
    var statusTimer = null;

    function byId(id){ return document.getElementById(id); }
    function setVal(id, v){
      var el = byId(id); if (!el) return;
      if (Object.prototype.toString.call(v) === '[object Array]') el.value = v.join('\\n');
      else el.value = (v == null ? '' : String(v));
    }
    function showStatus(msg, kind, holdMs){
      var el = byId('cbf-status'); if (!el) return;
      el.className = ''; // reset
      if (kind === 'ok') el.className = 'ok';
      else if (kind === 'error') el.className = 'error';
      el.textContent = msg || '';
      el.style.display = msg ? 'block' : 'none';
      if (statusTimer) { clearTimeout(statusTimer); statusTimer = null; }
      if (holdMs && holdMs > 0) {
        statusTimer = setTimeout(function(){ el.style.display='none'; }, holdMs);
      }
    }

    function basePath(){
      // /web/configurationpage?...           -> ''
      // /jellyfin/web/configurationpage?...  -> '/jellyfin'
      var p = window.location.pathname;
      var i = p.indexOf('/web/');
      return (i >= 0) ? p.substring(0, i) : '';
    }
    function urls(){
      var b = basePath();
      return {
        cfg  : b + '/Plugins/CollectionsByFolder/Config',
        save : b + '/Plugins/CollectionsByFolder/Save',
        scan : b + '/Plugins/CollectionsByFolder/Scan'
      };
    }

    function request(method, url, body, contentType, ok, err){
      if (window.fetch) {
        var opt = { method: method, cache: 'no-store' };
        if (contentType) opt.headers = { 'Content-Type': contentType };
        if (body != null) opt.body = body;
        window.fetch(url, opt).then(function(r){
          if (!r.ok) throw new Error('HTTP ' + r.status);
          return r.text();
        }).then(function(t){ ok && ok(t); }).catch(function(e){ err && err(e); });
        return;
      }
      // XHR Fallback (alte Browser)
      try {
        var xhr = new XMLHttpRequest();
        xhr.open(method, url, true);
        if (contentType) xhr.setRequestHeader('Content-Type', contentType);
        xhr.onreadystatechange = function(){
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) ok && ok(xhr.responseText);
            else err && err(new Error('HTTP ' + xhr.status));
          }
        };
        xhr.send(body || null);
      } catch (e) { err && err(e); }
    }

    function toURLEncoded(form){
      var fd = new FormData(form);
      var pairs = [];
      fd.forEach(function(v,k){ pairs.push(encodeURIComponent(k)+'='+encodeURIComponent(v)); });
      return pairs.join('&');
    }

    function load(){
      var u = urls();
      showStatus('Lade…');
      request('GET', u.cfg, null, null, function(text){
        var c = {};
        try { c = JSON.parse(text || '{}'); } catch (e) {}
        setVal('whitelist', c.whitelist || []);
        setVal('blacklist', c.blacklist || []);
        setVal('prefix',    c.prefix    || '');
        setVal('suffix',    c.suffix    || '');
        var mf = byId('minfiles'); if (mf) mf.value = String((c.minfiles != null ? c.minfiles : 0));
        showStatus('Bereit', 'ok', 1200);
      }, function(){
        showStatus('Fehler beim Laden', 'error', 3000);
      });
    }

    // Speichern (fetch/XHR). Bei Fehler: sauberer Fallback auf echtes Submit.
    var form = byId('cbfForm');
    if (form) {
      form.addEventListener('submit', function (e) {
        e.preventDefault ? e.preventDefault() : (e.returnValue = false);
        e.stopPropagation && e.stopPropagation();

        var u = urls();
        form.action = u.save; // Fallback-URL setzen
        var saveBtn = byId('saveButton'); if (saveBtn) saveBtn.disabled = true;

        showStatus('Speichern…');
        request('POST', u.save, toURLEncoded(form), 'application/x-www-form-urlencoded',
          function(){ // OK
            showStatus('Gespeichert ✔', 'ok', 3000);
            if (saveBtn) saveBtn.disabled = false;
            load();
          },
          function(){ // Fehler -> klassisch submitten
            showStatus('Netzwerkfehler – klassischer Submit…', 'error', 3000);
            try { setTimeout(function(){ form.submit(); }, 150); } catch(_) {}
            if (saveBtn) saveBtn.disabled = false;
          }
        );
      }, true);
    }

    // „Jetzt scannen“
    var scanBtn = byId('scanButton');
    if (scanBtn) {
      scanBtn.addEventListener('click', function(){
        var u = urls();
        scanBtn.disabled = true;
        showStatus('Scan gestartet…');
        request('POST', u.scan, '', 'application/x-www-form-urlencoded',
          function(){
            showStatus('Scan abgeschlossen ✔', 'ok', 3000);
            scanBtn.disabled = false;
          },
          function(){
            showStatus('Scan fehlgeschlagen', 'error', 5000);
            scanBtn.disabled = false;
          }
        );
      }, true);
    }

    if (document.readyState !== 'loading') load();
    else document.addEventListener('DOMContentLoaded', load, true);
  })();
  </script>
</div>
