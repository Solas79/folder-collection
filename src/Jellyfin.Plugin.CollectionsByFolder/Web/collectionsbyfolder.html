<!-- Web/collectionsbyfolder.html -->
<div data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-title="Collections by Folder"
     data-pluginid="f58f3a40-6a8a-48e8-9b3a-9d7f0b6a3a41"
     id="cbfPage">

  <style>
    /* Überschrift tiefer, kollidiert nicht mit Zurück-Pfeil */
    #cbfPage h1 { margin-top: 1.25rem; }

    /* Statusfeld optisch wie Button */
    #cbf-status {
      display: none;
      margin: .75rem 0 1rem 0;
      padding: .65rem .9rem;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
      background: rgba(255,255,255,.06);
      font-weight: 600;
    }
    #cbf-status.ok    { color: #0a7a0a; }
    #cbf-status.error { color: #b00020; }
  </style>

  <div data-role="content" class="content-primary">
    <h1>Collections by Folder</h1>

    <div id="cbf-status" aria-live="polite"></div>

    <form id="cbfForm"
          method="post"
          action="#"
          enctype="application/x-www-form-urlencoded"
          data-ajax="false">

      <div class="inputContainer">
        <label for="whitelist">Whitelist (ein Pfad pro Zeile)</label>
        <textarea id="whitelist" name="whitelist" rows="6" spellcheck="false"></textarea>
      </div>

      <div class="inputContainer">
        <label for="blacklist">Blacklist (ein Pfad pro Zeile)</label>
        <textarea id="blacklist" name="blacklist" rows="6" spellcheck="false"></textarea>
      </div>

      <div class="inputContainer">
        <label for="prefix">Präfix</label>
        <input id="prefix" name="prefix" type="text" />
      </div>

      <div class="inputContainer">
        <label for="suffix">Suffix</label>
        <input id="suffix" name="suffix" type="text" />
      </div>

      <div class="inputContainer">
        <label for="minfiles">Mindestanzahl Dateien</label>
        <input id="minfiles" name="minfiles" type="number" min="0" value="0" />
      </div>

      <div class="flex" style="gap:.75rem; margin-top:1rem; display:flex; flex-wrap:wrap;">
        <button is="emby-button" type="submit" class="raised button block" id="saveButton">
          Speichern
        </button>
        <button is="emby-button" type="button" class="raised button block" id="scanButton">
          Jetzt scannen
        </button>
      </div>
    </form>

    <p class="fieldDescription" style="margin-top:1rem;">
      Die aktuellen Werte werden automatisch geladen. Beim Speichern bleibt die Seite offen.
    </p>
  </div>

  <!-- Inline-Script: BasePath erkennen, Werte laden, Speichern mit Fallback, Scan -->
  <script>
  (function () {
    var statusTimer = null;

    function byId(id){ return document.getElementById(id); }
    function pathBase(){
      // Beispiel-Pfade:
      //  /web/configurationpage?name=...         -> base = ''
      //  /jellyfin/web/configurationpage?name=...-> base = '/jellyfin'
      var p = window.location.pathname;
      var i = p.indexOf('/web/');
      return (i >= 0) ? p.slice(0, i) : '';
    }
    function urls(){
      var base = pathBase();
      return {
        cfg  : base + '/Plugins/CollectionsByFolder/Config',
        save : base + '/Plugins/CollectionsByFolder/Save',
        scan : base + '/Plugins/CollectionsByFolder/Scan'
      };
    }
    function setVal(id, v){
      var el = byId(id); if (!el) return;
      if (Array.isArray(v)) el.value = v.join('\n');
      else el.value = (v == null ? '' : String(v));
    }
    function showStatus(msg, kind, holdMs){
      var el = byId('cbf-status'); if (!el) return;
      el.classList.remove('ok','error');
      if (kind === 'ok') el.classList.add('ok');
      else if (kind === 'error') el.classList.add('error');
      el.textContent = msg || '';
      el.style.display = msg ? 'block' : 'none';
      if (statusTimer) { clearTimeout(statusTimer); statusTimer = null; }
      if (holdMs && holdMs > 0) {
        statusTimer = setTimeout(function(){ el.style.display='none'; }, holdMs);
      }
    }
    function load(){
      var u = urls();
      showStatus('Lade…');
      fetch(u.cfg, { cache:'no-store' })
        .then(function(r){ return r.ok ? r.json() : {}; })
        .then(function(c){
          setVal('whitelist', c.whitelist || []);
          setVal('blacklist', c.blacklist || []);
          setVal('prefix',    c.prefix    || '');
          setVal('suffix',    c.suffix    || '');
          var mf = byId('minfiles'); if (mf) mf.value = String(c.minfiles ?? 0);
          showStatus('Bereit', 'ok', 1200);
        })
        .catch(function(){ showStatus('Fehler beim Laden', 'error', 3000); });
    }
    function toUrlEncoded(form){
      var fd = new FormData(form);
      var usp = new URLSearchParams();
      fd.forEach(function(v,k){ usp.append(k, v); });
      return usp.toString();
    }

    // Speichern mit Fallback: erst fetch, bei Fehler -> normale Submission
    var form = byId('cbfForm');
    var saveBtn = byId('saveButton');
    if (form) {
      // action-URL zur Laufzeit korrekt setzen (BasePath-sicher)
      form.action = urls().save;

      form.addEventListener('submit', function (e) {
        e.preventDefault(); e.stopPropagation();
        var u = urls();
        if (saveBtn) saveBtn.disabled = true;
        showStatus('Speichern…');

        fetch(u.save, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: toUrlEncoded(form)
        })
        .then(function(r){
          if (!r.ok) throw new Error('HTTP '+r.status);
          return r.text();
        })
        .then(function(){
          showStatus('Gespeichert ✔', 'ok', 3000);
          load();
        })
        .catch(function(err){
          // Fallback: normale Form-Submission (bleibt BasePath-korrekt)
          try {
            showStatus('Netzwerkfehler – klassischer Submit…', 'error', 3000);
            // kurz Verzögerung, dann echtes submit
            setTimeout(function(){ form.submit(); }, 150);
          } catch (e2) {
            showStatus('Fehler: ' + (err && err.message || err), 'error', 5000);
          }
        })
        .finally(function(){ if (saveBtn) saveBtn.disabled = false; });
      }, { capture: true });
    }

    // „Jetzt scannen“
    var scanBtn = byId('scanButton');
    if (scanBtn) {
      scanBtn.addEventListener('click', function(){
        var u = urls();
        scanBtn.disabled = true;
        showStatus('Scan gestartet…');
        fetch(u.scan, { method: 'POST' })
          .then(function(r){
            if (!r.ok) throw new Error('HTTP '+r.status);
            return r.text();
          })
          .then(function(){
            showStatus('Scan abgeschlossen ✔', 'ok', 3000);
          })
          .catch(function(err){
            showStatus('Scan fehlgeschlagen: ' + (err && err.message || err), 'error', 5000);
          })
          .finally(function(){ scanBtn.disabled = false; });
      }, { capture: true });
    }

    if (document.readyState !== 'loading') load();
    else document.addEventListener('DOMContentLoaded', load, { once:true });
  })();
  </script>
</div>
