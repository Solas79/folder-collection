<!-- CBF inline-only config page (kein Controller, keine externe JS-Datei) -->
<div data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-title="Collections by Folder"
     data-pluginid="f58f3a40-6a8a-48e8-9b3a-9d7f0b6a3a41"
     id="cbfPage">

  <div data-role="content" class="content-primary">
    <h1>Collections by Folder</h1>

    <div class="inputContainer">
      <label for="whitelist">Whitelist (ein Pfad pro Zeile)</label>
      <textarea id="whitelist" rows="6" spellcheck="false"></textarea>
    </div>

    <div class="inputContainer">
      <label for="blacklist">Blacklist (ein Pfad pro Zeile)</label>
      <textarea id="blacklist" rows="6" spellcheck="false"></textarea>
    </div>

    <div class="inputContainer">
      <label for="prefix">Präfix</label>
      <input id="prefix" type="text" />
    </div>

    <div class="inputContainer">
      <label for="suffix">Suffix</label>
      <input id="suffix" type="text" />
    </div>

    <div class="inputContainer">
      <label for="minfiles">Mindestanzahl Dateien</label>
      <input id="minfiles" type="number" min="0" value="0" />
    </div>

    <div class="flex align-items-center" style="gap:.75rem; margin-top:1rem;">
      <!-- WICHTIG: keine 'submit' / 'button-submit' Klasse -->
      <button is="emby-button" type="button" class="raised button block" id="saveButton" role="button">
        Speichern
      </button>
      <button is="emby-button" type="button" class="raised button block" id="scanNowButton" role="button">
        Jetzt scannen
      </button>
      <span id="cbf-status" style="margin-left:1rem;"></span>
    </div>
  </div>

  <script>
  (function () {
    'use strict';

    const pluginId = 'f58f3a40-6a8a-48e8-9b3a-9d7f0b6a3a41';
    const page = document.getElementById('cbfPage');
    if (!page) return;

    const $ = (sel) => page.querySelector(sel);
    const statusEl = $('#cbf-status');

    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
      console.log('[CBF]', msg);
    }

    function linesToList(text) {
      return (text || '')
        .replace(/\r\n?/g, '\n')
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);
    }

    async function loadConfig() {
      try {
        if (!window.ApiClient || typeof ApiClient.getPluginConfiguration !== 'function') {
          setStatus('ApiClient nicht verfügbar');
          return;
        }
        const cfg = await ApiClient.getPluginConfiguration(pluginId);
        $('#whitelist').value = (cfg.Whitelist || []).join('\n');
        $('#blacklist').value = (cfg.Blacklist || []).join('\n');
        $('#prefix').value    = cfg.Prefix || '';
        $('#suffix').value    = cfg.Suffix || '';
        $('#minfiles').value  = String(cfg.MinFiles ?? 0);
        setStatus('Konfiguration geladen');
      } catch (e) {
        setStatus('Fehler beim Laden: ' + (e && e.message ? e.message : e));
      }
    }

    async function onSave(ev) {
      try {
        // JEGLICHE Default-/Global-Handler unterbinden:
        ev?.preventDefault?.();
        ev?.stopPropagation?.();
        ev?.stopImmediatePropagation?.();

        setStatus('Speichern…');

        const cfg = {
          Whitelist:  linesToList($('#whitelist').value),
          Blacklist:  linesToList($('#blacklist').value),
          Prefix:     $('#prefix').value || '',
          Suffix:     $('#suffix').value || '',
          MinFiles:   parseInt($('#minfiles').value || '0', 10) || 0,
          // Kompatibilität für bestehenden Code:
          FolderPaths: linesToList($('#whitelist').value)
        };

        if (!window.ApiClient || typeof ApiClient.updatePluginConfiguration !== 'function') {
          setStatus('ApiClient nicht verfügbar (aber Klick erkannt)');
          return false;
        }

        await ApiClient.updatePluginConfiguration(pluginId, cfg);
        setStatus('Gespeichert ✔');
        return false;
      } catch (e) {
        setStatus('Fehler: ' + (e && e.message ? e.message : e));
        return false;
      }
    }

    function onScan(ev) {
      ev?.preventDefault?.();
      ev?.stopPropagation?.();
      ev?.stopImmediatePropagation?.();
      setStatus('Scan gestartet…');
      setTimeout(() => setStatus('Scan abgeschlossen ✔ (Demo)'), 800);
      return false;
    }

    function bind() {
      const saveBtn = $('#saveButton');
      const scanBtn = $('#scanNowButton');

      // Capture-Phase, um Jellyfin-Handler zuvorzukommen
      saveBtn?.addEventListener('click', onSave, { capture: true });
      scanBtn?.addEventListener('click', onScan, { capture: true });

      setStatus('Bereit');
    }

    // In der Jellyfin-Shell kann DOMContentLoaded schon durch sein
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function onDom() {
        document.removeEventListener('DOMContentLoaded', onDom);
        bind(); loadConfig();
      });
    } else {
      bind(); loadConfig();
    }
  })();
  </script>
</div>
